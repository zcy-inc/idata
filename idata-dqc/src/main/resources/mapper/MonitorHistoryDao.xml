<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.zhengcaiyun.idata.dqc.dao.MonitorHistoryDao">

    <select id="getByRuleId" resultType="cn.zhengcaiyun.idata.dqc.model.entity.MonitorHistory">
        select `id`, `table_name` tableName, `partition`, `rule_id` ruleId, `baseline_id` baselineId, `template_id` templateId, `rule_name` ruleName,
               `rule_type` ruleType, `monitor_obj` monitorObj, `alarm_level` alarmLevel, `alarm_receivers` alarmReceivers,
               `compare_type` compareType, `check_type` checkType, `content`, `fix_value` fixvalue, `range_start` rangestart,
               `range_end` rangeEnd, `alarm`, `data_value` dataValue, `rule_value` ruleValue, `version`, `creator`, `create_time`
        from dqc_monitor_history
        where rule_id = #{ruleId} and create_time > date_add(now(), interval -30 day)
        order by create_time desc
    </select>

    <select id="getByBaselineId" resultType="cn.zhengcaiyun.idata.dqc.model.entity.MonitorHistory">
        select  `id`, `table_name` tableName, `partition`, `rule_id` ruleId, `baseline_id` baselineId, `template_id` templateId, `rule_name` ruleName,
                `rule_type` ruleType, `monitor_obj` monitorObj, `alarm_level` alarmLevel, `alarm_receivers` alarmReceivers,
                `compare_type` compareType, `check_type` checkType, `content`, `fix_value` fixvalue, `range_start` rangestart,
                `range_end` rangeEnd, `alarm`, `data_value` dataValue, `rule_value` ruleValue, `version`, `creator`, `create_time`
        from dqc_monitor_history
        where baseline_id = #{baselineId} and create_time > date_add(now(), interval -30 day)
        order by create_time desc
    </select>

    <select id="getByPage" resultType="cn.zhengcaiyun.idata.dqc.model.entity.MonitorHistory" parameterType="cn.zhengcaiyun.idata.dqc.model.entity.MonitorHistory">
        select `id`, `table_name` tableName, `partition`, `rule_id` ruleId, `rule_name` ruleName, `rule_type` ruleType,
               `monitor_obj` monitorObj, `alarm_level` alarmLevel,`alarm_receivers` alarmReceivers, `compare_type` compareType,
               `check_type` checkType, `content`, `fix_value` fixValue, `range_start` rangeStart, `range_end` rangeEnd, `alarm`,
               `data_value` dataValue,`rule_value` ruleValue, `version`, `creator`, `create_time`, `editor`, `edit_time`
        from dqc_monitor_history
        <where>
            <if test="tableName != null and tableName != ''">
                and table_name = #{tableName}
            </if>
            <if test="partition != null and partition != ''">
                and partition = #{partition}
            </if>
            <if test="ruleId != null">
                and rule_id = #{ruleId}
            </if>
            <if test="ruleName != null and ruleName != ''">
                and rule_name = #{ruleName}
            </if>
            <if test="ruleType != null">
                and rule_type = #{ruleType}
            </if>
            <if test="monitorObj != null and monitorObj != ''">
                and monitor_obj = #{monitorObj}
            </if>
            <if test="dataValue != null and dataValue != ''">
                and data_value = #{dataValue}
            </if>
            <if test="runSql != null and runSql != ''">
                and run_sql = #{runSql}
            </if>
            <if test="ruleValue != null and ruleValue != ''">
                and rule_value = #{ruleValue}
            </if>
            <if test="version != null and version != ''">
                and version = #{version}
            </if>
            <if test="creator != null and creator != ''">
                and creator = #{creator}
            </if>
            <if test="createTime != null">
                and create_time = #{createTime}
            </if>
            <if test="editor != null and editor != ''">
                and editor = #{editor}
            </if>
            <if test="editTime != null">
                and edit_time = #{editTime}
            </if>
            <if test="alarmLevel != null">
                and alarm_level = #{alarmLevel}
            </if>
        </where>
        limit #{query.startIndex}, #{query.pageSize}
    </select>

    <select id="count" resultType="java.lang.Integer" parameterType="cn.zhengcaiyun.idata.dqc.model.entity.MonitorHistory">
        select count(1)
        from dqc_monitor_history
        <where>
            <if test="tableName != null and tableName != ''">
                and table_name = #{tableName}
            </if>
            <if test="partition != null and partition != ''">
                and partition = #{partition}
            </if>
            <if test="ruleId != null">
                and rule_id = #{ruleId}
            </if>
            <if test="ruleName != null and ruleName != ''">
                and rule_name = #{ruleName}
            </if>
            <if test="ruleType != null">
                and rule_type = #{ruleType}
            </if>
            <if test="monitorObj != null and monitorObj != ''">
                and monitor_obj = #{monitorObj}
            </if>
            <if test="dataValue != null and dataValue != ''">
                and data_value = #{dataValue}
            </if>
            <if test="runSql != null and runSql != ''">
                and run_sql = #{runSql}
            </if>
            <if test="ruleValue != null and ruleValue != ''">
                and rule_value = #{ruleValue}
            </if>
            <if test="version != null and version != ''">
                and version = #{version}
            </if>
            <if test="creator != null and creator != ''">
                and creator = #{creator}
            </if>
            <if test="createTime != null">
                and create_time = #{createTime}
            </if>
            <if test="editor != null and editor != ''">
                and editor = #{editor}
            </if>
            <if test="editTime != null">
                and edit_time = #{editTime}
            </if>
            <if test="alarmLevel != null">
                and alarm_level = #{alarmLevel}
            </if>
        </where>
    </select>

    <insert id="insert" keyProperty="id" useGeneratedKeys="true" >
        insert into dqc_monitor_history
            ( `table_name`, `partition`, `rule_id`, `rule_name`, `rule_type`, `monitor_obj`,compare_type,baseline_id,template_id,
              `alarm_level`, `alarm_receivers`, `fix_value`, `range_start`, `range_end`, `run_sql`, `alarm`,check_type,
              content,`data_value`, `rule_value`, `version`, `creator`, `create_time`, `editor`, `edit_time`)
        values
            (#{entity.tableName}, #{entity.partition}, #{entity.ruleId}, #{entity.ruleName}, #{entity.ruleType}, #{entity.monitorObj}, #{entity.compareType},#{entity.baselineId}, #{entity.templateId},
             #{entity.alarmLevel}, #{entity.alarmReceivers},#{entity.fixValue},#{entity.rangeStart},#{entity.rangeEnd},#{entity.runSql},#{entity.alarm},#{entity.checkType},
             #{entity.content}, #{entity.dataValue},  #{entity.ruleValue}, #{entity.version}, #{entity.creator}, now(), #{entity.editor}, now())
    </insert>

    <insert id="insertBatch" keyProperty="id" useGeneratedKeys="true">
        INSERT INTO `dqc_monitor_history`
            ( `table_name`, `partition`, `rule_id`, `rule_name`, `rule_type`, `monitor_obj`,compare_type,baseline_id,template_id,
             `alarm_level`, `alarm_receivers`, `fix_value`, `range_start`, `range_end`, `run_sql`, `alarm`,check_type,
            content,`data_value`, `rule_value`, `version`, `creator`, `create_time`, `editor`, `edit_time`)
        values
        <foreach collection="entities" item="entity" separator=",">
        (#{entity.tableName}, #{entity.partition}, #{entity.ruleId}, #{entity.ruleName}, #{entity.ruleType}, #{entity.monitorObj}, #{entity.compareType},#{entity.baselineId}, #{entity.templateId},
            #{entity.alarmLevel}, #{entity.alarmReceivers},#{entity.fixValue},#{entity.rangeStart},#{entity.rangeEnd},#{entity.runSql},#{entity.alarm},#{entity.checkType},
            #{entity.content},#{entity.dataValue},  #{entity.ruleValue}, #{entity.version}, #{entity.creator}, now(), #{entity.editor}, now())
        </foreach>
    </insert>

    <select id="getLatest" resultType="cn.zhengcaiyun.idata.dqc.model.entity.MonitorHistory">
        select id, table_name tableName, `partition`, rule_id ruleId, rule_name ruleName, rule_type ruleType, monitor_obj monitorObj,
        data_value dataValue, `run_sql` runSql, rule_value ruleValue, version,compare_type compareType,baseline_id baselineId,template_id templateId,
        creator, create_time createTime, editor, edit_time editTime, alarm_level alarmlevel
        from dqc_monitor_history
        where id in(
        select max(id)
        from dqc_monitor_history
        where rule_id = #{ruleId} and table_name=#{tableName}
        <if test="partition != null and partition != ''">
            `partition` = #{partition}
        </if>
        )
    </select>
</mapper>

